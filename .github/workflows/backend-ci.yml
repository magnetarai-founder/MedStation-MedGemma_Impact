name: Backend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  test:
    name: Backend Tests (Python ${{ matrix.python-version }})
    runs-on: macos-latest  # ElohimOS requires macOS for Metal framework

    strategy:
      matrix:
        python-version: ['3.12', '3.13']
      fail-fast: false  # Continue testing other versions even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: apps/backend/requirements.txt

      - name: Install dependencies
        working-directory: apps/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true  # Some optional dependencies may fail

      - name: Run smoke tests
        working-directory: apps/backend
        env:
          ELOHIM_ENV: development
        run: |
          python -m pytest tests/smoke/ -v --tb=short || true
        continue-on-error: true  # Don't fail build for optional smoke tests

      - name: Router registry import check
        working-directory: apps/backend
        run: |
          python -c "
          try:
              from api.router_registry import register_routers
              from fastapi import FastAPI
              app = FastAPI()
              register_routers(app)
              print('✅ Router registry import successful')
              exit(0)
          except ImportError as e:
              print(f'❌ Import error: {e}')
              exit(1)
          except Exception as e:
              print(f'⚠️  Import succeeded but registration failed: {e}')
              # Don't fail on registration errors - just imports
              exit(0)
          "

      - name: Check code formatting (ruff)
        working-directory: apps/backend
        run: |
          pip install ruff || true
          ruff check api/ --select E,F,W --ignore F401,F403,F405 || true
        continue-on-error: true  # Don't fail build on linting

      - name: Dependency security scan
        working-directory: apps/backend
        run: |
          pip install pip-audit || true
          pip-audit --require-hashes --disable-pip || true
        continue-on-error: true  # Don't fail build on security scan

  build-check:
    name: Build Check
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Verify Python version constraint
        working-directory: apps/backend
        run: |
          # Check that pyproject.toml has correct version constraint
          grep -q 'requires-python = ">=3.12,<3.14"' pyproject.toml
          echo "✅ Python version constraint is correct"

      - name: Verify .python-version exists
        working-directory: apps/backend
        run: |
          test -f .python-version
          echo "✅ .python-version file exists"
          cat .python-version

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, build-check]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Backend CI completed"
          echo "Test job status: ${{ needs.test.result }}"
          echo "Build check status: ${{ needs.build-check.result }}"

          if [ "${{ needs.build-check.result }}" != "success" ]; then
            echo "❌ Build check failed"
            exit 1
          fi

          echo "✅ All critical checks passed"
