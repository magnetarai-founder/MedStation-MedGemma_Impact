name: Code Quality Checks

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check-file-sizes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Check for oversized files
        continue-on-error: true
        run: |
          echo "Checking for files larger than 1200 lines..."

          # Find files larger than 1200 lines
          oversized=$(find . -type f \( -name "*.py" -o -name "*.ts" -o -name "*.tsx" \) \
                     -not -path "*/venv/*" \
                     -not -path "*/node_modules/*" \
                     -not -path "*/dist/*" \
                     -not -path "*/.neutron_data/*" \
                     -not -path "*/.vite/*" \
                     -not -path "*/apps/backend/external/*" \
                     -exec sh -c 'lines=$(wc -l < "$1"); if [ "$lines" -gt 1200 ]; then echo "$1 ($lines lines)"; fi' _ {} \;)

          if [ -n "$oversized" ]; then
            echo "⚠️  Warning: Large files detected (>1200 lines):"
            echo "$oversized"
            echo ""
            echo "Consider refactoring files larger than 1200 lines."
          else
            echo "✅ All files are appropriately sized"
          fi

          exit 0

  backend-dev-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: apps/backend/requirements.txt

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/backend/requirements.txt
          pip install pytest

      - name: Run import validation
        run: |
          python scripts/check_imports.py

      - name: Run backend tests
        env:
          ELOHIM_ENV: development
          ELOHIM_JWT_SECRET: test_secret_for_ci_only
          ELOHIMOS_JWT_SECRET_KEY: test_secret_for_ci_only
          PYTHONPATH: ${{ github.workspace }}/packages:${{ github.workspace }}/apps/backend
        working-directory: apps/backend
        run: |
          python -m pytest tests/ -v
