name: Frontend Linting & Checks

on:
  push:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - '.github/workflows/frontend-lint.yml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - '.github/workflows/frontend-lint.yml'

jobs:
  lint-checks:
    name: Frontend Lint & Import Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for banned imports
        run: |
          echo "üîç Checking for banned package imports..."

          # Check for sonner imports (should use react-hot-toast)
          if grep -r "from ['\"]sonner['\"]" apps/frontend/src/ 2>/dev/null; then
            echo "‚ùå ERROR: Found 'sonner' imports. Use 'react-hot-toast' instead."
            echo "   The project uses react-hot-toast with Toaster configured in src/App.tsx"
            exit 1
          fi

          # Check for duplicate Toaster instances
          TOASTER_COUNT=$(grep -r "<Toaster" apps/frontend/src/ 2>/dev/null | grep -v "\.tsx~" | wc -l | tr -d ' ')
          if [ "$TOASTER_COUNT" -gt 1 ]; then
            echo "‚ùå ERROR: Found $TOASTER_COUNT Toaster instances. Should only be 1 in src/App.tsx"
            grep -rn "<Toaster" apps/frontend/src/ | grep -v "\.tsx~"
            exit 1
          fi

          echo "‚úÖ All import checks passed"

      - name: Check for direct toast imports (recommend wrapper)
        run: |
          echo "‚ÑπÔ∏è  Checking toast import patterns..."

          # Count direct react-hot-toast imports (informational, not blocking)
          DIRECT_IMPORTS=$(grep -r "import.*toast.*from ['\"]react-hot-toast['\"]" apps/frontend/src/ 2>/dev/null | grep -v "src/lib/toast.tsx" | wc -l | tr -d ' ')

          if [ "$DIRECT_IMPORTS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $DIRECT_IMPORTS files importing react-hot-toast directly"
            echo "   Consider using the wrapper in src/lib/toast.tsx for centralized theming"
            echo "   This is informational only - not blocking the build"
          else
            echo "‚úÖ All files use the toast wrapper"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: apps/frontend
        run: |
          if [ -f "package-lock.json" ]; then
            echo "üì¶ Using package-lock.json (npm ci)"
            npm ci
          else
            echo "‚ö†Ô∏è  No package-lock.json found, using npm install"
            npm install
          fi

      - name: Type check
        working-directory: apps/frontend
        run: npm run type-check || echo "‚ö†Ô∏è  Type check failed (informational)"
        continue-on-error: true

      - name: Build check
        working-directory: apps/frontend
        run: npm run build

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Frontend checks passed:"
          echo "   - No banned imports (sonner)"
          echo "   - Single Toaster instance"
          echo "   - Production build successful"
